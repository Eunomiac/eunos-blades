{"version":3,"sources":["../../ts/blades-active-effect.ts"],"names":[],"mappings":"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","file":"blades-active-effect.js","sourcesContent":["import BladesActor from \"./blades-actor.js\";\r\nimport U from \"./core/utilities.js\";\r\nimport BladesItem from \"./blades-item.js\";\r\nimport {Tag, BladesPhase, BladesActorType, BladesItemType, Attribute, InsightActions, ProwessActions, ResolveActions} from \"./core/constants.js\";\r\n\r\nconst FUNCQUEUE: Record<string, {\r\n  curFunc: Promise<void>,\r\n  queue: BladesCustomFuncData[]\r\n}> = {};\r\n// {type: \"ability\", name: \"rX:/^(?!Ghost)/\"}\r\nconst CUSTOMFUNCS: Record<string, (actor: BladesActor, funcData: string, effect: BladesActiveEffect, isReversing: boolean) => Promise<void>> = {\r\n  addItem: async (actor: BladesActor, funcData: string, effect, isReversing = false) => {\r\n    eLog.checkLog(\"activeEffects\", \"addItem\", {actor, funcData, isReversing});\r\n    if (actor.hasActiveSubItemOf(funcData)) {\r\n      if (isReversing) {\r\n        return actor.remSubItem(funcData);\r\n      }\r\n    } else {\r\n      if (!isReversing) {\r\n        return actor.addSubItem(funcData);\r\n      }\r\n    }\r\n    return undefined;\r\n  },\r\n  addIfChargen: async (actor, funcData, effect, isReversing = false) => {\r\n    eLog.checkLog(\"activeEffects\", \"addIfChargen\", {actor, funcData, isReversing});\r\n    if (!isReversing && game.eunoblades.Tracker!.system.phase !== BladesPhase.CharGen) { return undefined }\r\n    const [target, qty] = funcData.split(/:/);\r\n    if (isReversing) {\r\n      return actor.update({[target]: U.pInt(getProperty(actor, target)) - U.pInt(qty)});\r\n    }\r\n    return actor.update({[target]: U.pInt(getProperty(actor, target)) + U.pInt(qty)});\r\n  },\r\n  upgradeIfChargen: async (actor, funcData, effect, isReversing = false) => {\r\n    eLog.checkLog(\"activeEffects\", \"upgradeIfChargen\", {actor, funcData, isReversing});\r\n    if (!isReversing && game.eunoblades.Tracker!.system.phase !== BladesPhase.CharGen) { return undefined }\r\n    const [target, qty] = funcData.split(/:/);\r\n    if (getProperty(actor, target) < U.pInt(qty)) {\r\n      return actor.update({[target]: U.pInt(qty)});\r\n    }\r\n    return undefined;\r\n  },\r\n  APPLYTOMEMBERS: async () => { return undefined },\r\n  APPLYTOCOHORTS: async () => { return undefined },\r\n  remItem: async (actor, funcData, effect, isReversing = false) => {\r\n\r\n    function testString(targetString: string, testDef: string) {\r\n      if (/^rX/.test(testDef)) {\r\n        const pat = new RegExp(testDef.replace(/^rX:\\/(.*?)\\//, \"$1\"));\r\n        return pat.test(targetString);\r\n      }\r\n      return targetString === testDef;\r\n    }\r\n\r\n    if (/^{/.test(funcData)) {\r\n      if (isReversing) {\r\n        console.error(\"Cannot reverse a 'remItem' custom effect that was defined with a JSON object.\");\r\n        return undefined;\r\n      }\r\n      const {type, tags, name} = JSON.parse(funcData);\r\n      let activeSubItems = actor.activeSubItems;\r\n      if (activeSubItems.length === 0) { return undefined }\r\n      if (name) { activeSubItems = activeSubItems.filter((item) => testString(item.name!, name)) }\r\n      if (activeSubItems.length === 0) { return undefined }\r\n      if (type) { activeSubItems = activeSubItems.filter((item) => testString(item.type, type)) }\r\n      if (activeSubItems.length === 0) { return undefined }\r\n      if (tags) { activeSubItems = activeSubItems.filter((item) => item.hasTag(...tags)) }\r\n      if (activeSubItems.length === 0) { return undefined }\r\n      eLog.checkLog(\"activeEffects\", \"remItem - JSON OBJECT\", {actor, funcData: JSON.parse(funcData), isReversing, activeSubItems});\r\n      activeSubItems.forEach((item) => actor.remSubItem(item));\r\n    }\r\n    eLog.checkLog(\"activeEffects\", \"remItem\", {actor, funcData, isReversing});\r\n    if (actor.hasActiveSubItemOf(funcData)) {\r\n      return actor.remSubItem(funcData);\r\n    }\r\n    if (isReversing) {\r\n      return actor.addSubItem(funcData);\r\n    }\r\n    return undefined;\r\n  }\r\n};\r\n\r\nenum EffectMode {\r\n  Custom,\r\n  Multiply,\r\n  Add,\r\n  Downgrade,\r\n  Upgrade,\r\n  Override\r\n}\r\n\r\ntype EffectChangeData = {\r\n  key: string,\r\n  mode: EffectMode,\r\n  priority: number|null,\r\n  value: string\r\n};\r\n\r\ntype BladesCustomFuncName = KeyOf<typeof CUSTOMFUNCS>;\r\ntype BladesCustomFuncData = {\r\n  funcName: BladesCustomFuncName,\r\n  funcData: string,\r\n  isReversing: boolean,\r\n  effect: BladesActiveEffect\r\n}\r\n\r\n// type BladesCustomFuncParams = Parameters<ValueOf<typeof CUSTOMFUNCS>>[1];\r\n\r\n// type BladesCustomFunc = (actor: BladesActor, params: BladesCustomFuncParams) => Promise<void>;\r\n// type BladesCustomResult = ReturnType<BladesCustomFunc>;\r\n\r\n// type BladesCustomEffectData = {\r\n//   func: BladesCustomFuncName,\r\n//   params: BladesCustomFuncParams\r\n// }\r\n\r\nclass BladesActiveEffect extends ActiveEffect {\r\n  static Initialize() {\r\n    CONFIG.ActiveEffect.documentClass = BladesActiveEffect;\r\n\r\n    Hooks.on(\"preCreateActiveEffect\", async (effect: BladesActiveEffect) => {\r\n\r\n      eLog.checkLog3(\"effect\", \"PRECREATE ActiveEffect\", {effect, parent: effect.parent?.name});\r\n\r\n      if (!(effect.parent instanceof BladesActor)) { return }\r\n\r\n      // Does this effect have an \"APPLYTOMEMBERS\" or \"APPLYTOCOHORTS\" CUSTOM effect?\r\n      if (effect.changes.some((change) => change.key === \"APPLYTOMEMBERS\")) {\r\n\r\n        if (BladesActor.IsType(effect.parent, BladesActorType.pc) && BladesActor.IsType(effect.parent.crew, BladesActorType.crew)) {\r\n          const otherMembers = effect.parent.crew.members.filter((member) => member.id !== effect.parent!.id);\r\n          if (otherMembers.length > 0) {\r\n            // If PC & APPLYTOMEMBERS   --> Create effect on members MINUS the 'APPLYTOMEMBERS' key, leave PC's effect unchanged.\r\n            effect.changes = effect.changes.filter((change) => change.key !== \"APPLYTOMEMBERS\");\r\n            await Promise.all(otherMembers.map(async (member) => member.createEmbeddedDocuments(\"ActiveEffect\", [effect as any])));\r\n            // Set flag with effect's data on member, so future members can have effect applied to them.\r\n            await effect.parent.setFlag(\"eunos-blades\", `memberEffects.${effect.id}`, {\r\n              appliedTo: otherMembers.map((member) => member.id),\r\n              effect\r\n            });\r\n          }\r\n        } else if (BladesActor.IsType(effect.parent, BladesActorType.crew)) {\r\n          const changeKey = U.pullElement(effect.changes, (change) => change.key === \"APPLYTOMEMBERS\") as EffectChangeData;\r\n          if (effect.parent.members.length > 0) {\r\n            // If Crew & APPLYTOMEMBERS --> Create effect on members MINUS the 'APPLYTOMEMBERS' key\r\n            await Promise.all(effect.parent.members.map(async (member) => member.createEmbeddedDocuments(\"ActiveEffect\", [effect as any])));\r\n          }\r\n          // Set flag with effect's data on crew, so future members can have effect applied to them.\r\n          await effect.parent.setFlag(\"eunos-blades\", `memberEffects.${effect.id}`, {\r\n            appliedTo: effect.parent.members.map((member) => member.id),\r\n            effect\r\n          });\r\n          // Update effect on crew-parent to only include 'APPLYTOMEMBERS' change\r\n          await effect.updateSource({changes: [changeKey]});\r\n        }\r\n      } else if (effect.changes.some((change) => change.key === \"APPLYTOCOHORTS\")) {\r\n        if (BladesActor.IsType(effect.parent, BladesActorType.pc) || BladesActor.IsType(effect.parent, BladesActorType.crew)) {\r\n          if (effect.parent.cohorts.length > 0) {\r\n            // If APPLYTOCOHORTS   --> Create effect on cohorts\r\n            await Promise.all(effect.parent.cohorts.map(async (cohort) => cohort.createEmbeddedDocuments(\"ActiveEffect\", [effect as any])));\r\n          }\r\n          // Set flag with effect's data on parent, so future cohorts can have effect applied to them.\r\n          await (effect.parent as BladesActor).setFlag(\"eunos-blades\", `cohortEffects.${effect.id}`, {\r\n            appliedTo: effect.parent.cohorts.map((cohort) => cohort.id),\r\n            effect\r\n          });\r\n          // Update effect on parent to only include 'APPLYTOCOHORTS' change\r\n          await effect.updateSource({changes: effect.changes.filter((change) => change.key === \"APPLYTOCOHORTS\")});\r\n        }\r\n      }\r\n\r\n      // Partition effect.changes into permanent and non-permanent changes:\r\n      const [permChanges, changes] = U.partition(effect.changes, (change) => /^perm/.test(change.key));\r\n      await effect.updateSource({changes});\r\n\r\n      for (const permChange of permChanges) {\r\n        const {key, value} = permChange;\r\n        const permFuncName = key.replace(/^perm/, \"\");\r\n        if (permFuncName in CUSTOMFUNCS) {\r\n          const funcData: BladesCustomFuncData = {\r\n            funcName: permFuncName as BladesCustomFuncName,\r\n            funcData: value,\r\n            isReversing: false,\r\n            effect\r\n          };\r\n          BladesActiveEffect.ThrottleCustomFunc(effect.parent as BladesActor, funcData);\r\n        } else {\r\n          switch(permFuncName) {\r\n            case \"Add\": {\r\n              const [target, qty] = value.split(/:/);\r\n              (<BladesActor>effect.parent).update({[target]: U.pInt(getProperty(<BladesActor>effect.parent, target)) + U.pInt(qty)});\r\n            }\r\n            // no default\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    Hooks.on(\"applyActiveEffect\", (actor: BladesActor, changeData: EffectChangeData & {effect: BladesActiveEffect}) => {\r\n\r\n      if (!(actor instanceof BladesActor)) { return }\r\n\r\n      if (changeData.key in CUSTOMFUNCS) {\r\n        const funcData: BladesCustomFuncData = {\r\n          funcName: changeData.key as BladesCustomFuncName,\r\n          funcData: changeData.value,\r\n          isReversing: false,\r\n          effect: changeData.effect\r\n        };\r\n        BladesActiveEffect.ThrottleCustomFunc(actor, funcData);\r\n      }\r\n    });\r\n\r\n    Hooks.on(\"updateActiveEffect\", (effect: BladesActiveEffect, {disabled}: {disabled: boolean}) => {\r\n      if (!(effect.parent instanceof BladesActor)) { return }\r\n      const customEffects = effect.changes.filter((changes: EffectChangeData) => changes.mode === 0);\r\n      customEffects.forEach(({key, value}) => {\r\n        const funcData: BladesCustomFuncData = {\r\n          funcName: key as BladesCustomFuncName,\r\n          funcData: value,\r\n          isReversing: disabled,\r\n          effect\r\n        };\r\n        BladesActiveEffect.ThrottleCustomFunc(effect.parent as BladesActor, funcData);\r\n      });\r\n    });\r\n\r\n    Hooks.on(\"deleteActiveEffect\", async (effect: BladesActiveEffect) => {\r\n      if (!(effect.parent instanceof BladesActor)) { return }\r\n\r\n      // Does this effect have an \"APPLYTOMEMBERS\" or \"APPLYTOCOHORTS\" CUSTOM effect?\r\n      if (effect.changes.some((change) => change.key === \"APPLYTOMEMBERS\")) {\r\n        if (BladesActor.IsType(effect.parent, BladesActorType.pc) && BladesActor.IsType(effect.parent.crew, BladesActorType.crew)) {\r\n          const otherMembers = effect.parent.crew.members.filter((member) => member.id !== effect.parent!.id);\r\n          if (otherMembers.length > 0) {\r\n            // If PC & APPLYTOMEMBERS   --> Delete effect on all other members.\r\n            await Promise.all(otherMembers\r\n              .map(async (member) => Promise.all(member.effects\r\n                .filter((e) => e.name === effect.name)\r\n                .map(async (e) => e.delete()))));\r\n          }\r\n          // Clear flag from parent\r\n          await effect.parent.unsetFlag(\"eunos-blades\", `memberEffects.${effect.id}`);\r\n        } else if (BladesActor.IsType(effect.parent, BladesActorType.crew)) {\r\n          if (effect.parent.members.length > 0) {\r\n            // If CREW & APPLYTOMEMBERS   --> Delete effect on all other members.\r\n            await Promise.all(effect.parent.members\r\n              .map(async (member) => Promise.all(member.effects\r\n                .filter((e) => e.name === effect.name)\r\n                .map(async (e) => e.delete()))));\r\n          }\r\n          // Clear flag from parent\r\n          await effect.parent.unsetFlag(\"eunos-blades\", `memberEffects.${effect.id}`);\r\n        }\r\n      } else if (effect.changes.some((change) => change.key === \"APPLYTOCOHORTS\")) {\r\n        if (BladesActor.IsType(effect.parent, BladesActorType.pc, BladesActorType.crew)) {\r\n          if (effect.parent.cohorts.length > 0) {\r\n            // If APPLYTOCOHORTS   --> Delete effect on cohorts.\r\n            await Promise.all(effect.parent.cohorts\r\n              .map(async (cohort) => Promise.all(cohort.effects\r\n                .filter((e) => e.name === effect.name)\r\n                .map(async (e) => e.delete()))));\r\n          }\r\n          // Clear flag from parent\r\n          await effect.parent.unsetFlag(\"eunos-blades\", `cohortEffects.${effect.id}`);\r\n        }\r\n      }\r\n\r\n      const customEffects = effect.changes.filter((changes: EffectChangeData) => changes.mode === 0);\r\n      customEffects.forEach(({key, value}) => {\r\n        const funcData: BladesCustomFuncData = {\r\n          funcName: key as BladesCustomFuncName,\r\n          funcData: value,\r\n          isReversing: true,\r\n          effect\r\n        };\r\n        BladesActiveEffect.ThrottleCustomFunc(effect.parent as BladesActor, funcData);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async AddActiveEffect(doc: BladesDoc, name: string, eChanges: EffectChangeData|EffectChangeData[], icon = \"systems/eunos-blades/assets/icons/effect-icons/default.png\") {\r\n    const changes = [eChanges].flat();\r\n    doc.createEmbeddedDocuments(\"ActiveEffect\", [{name, icon, changes}]);\r\n  }\r\n\r\n  static ThrottleCustomFunc(actor: BladesActor, data: BladesCustomFuncData) {\r\n    const {funcName, funcData, isReversing, effect} = data;\r\n    if (!actor.id) { return }\r\n    eLog.display(`Throttling Func: ${funcName}(${funcData}, ${isReversing})`);\r\n    // Is there a currently-running function for this actor?\r\n    if (actor.id && actor.id in FUNCQUEUE) {\r\n      // Is this a duplicate of a function already queued?\r\n      const matchingQueue = FUNCQUEUE[actor.id].queue.find((fData: BladesCustomFuncData) => JSON.stringify(fData) === JSON.stringify(data));\r\n      eLog.checkLog(\"activeEffects\", \"... Checking Queue\", {data, FUNCQUEUE: FUNCQUEUE[actor.id], matchingQueue});\r\n      if (matchingQueue) {\r\n        eLog.error(\"... Function ALREADY QUEUED, SKIPPING\");\r\n        return;\r\n      }\r\n      FUNCQUEUE[actor.id].queue.push(data);\r\n      return;\r\n    }\r\n    // If not, create FUNCQUEUE entry and run first function.\r\n    eLog.display(\"... Creating New FUNCQUEUE, RUNNING:\");\r\n    FUNCQUEUE[actor.id] = {\r\n      curFunc: BladesActiveEffect.RunCustomFunc(actor, CUSTOMFUNCS[funcName](actor, funcData, effect, isReversing)),\r\n      queue: []\r\n    };\r\n  }\r\n\r\n  static async RunCustomFunc(actor: BladesActor, funcPromise: Promise<void>): Promise<void> {\r\n    if (!actor.id) { return }\r\n    eLog.checkLog(\"activeEffects\", \"... Running Func ...\");\r\n    await funcPromise;\r\n    eLog.checkLog(\"activeEffects\", \"... Function Complete!\");\r\n    if (FUNCQUEUE[actor.id].queue.length) {\r\n      const {funcName, funcData, isReversing, effect} = FUNCQUEUE[actor.id].queue.shift()!;\r\n      eLog.display(`Progressing Queue: ${funcName}(${funcData}, ${isReversing}) -- ${FUNCQUEUE[actor.id].queue.length} remaining funcs.`);\r\n      FUNCQUEUE[actor.id].curFunc = BladesActiveEffect.RunCustomFunc(actor, CUSTOMFUNCS[funcName](actor, funcData, effect, isReversing));\r\n    } else {\r\n      eLog.display(\"Function Queue Complete! Deleting.\");\r\n      delete FUNCQUEUE[actor.id];\r\n    }\r\n  }\r\n  /**\r\n   * Manage Active Effect instances through the Actor Sheet via effect control buttons.\r\n   * @param {MouseEvent} event      The left-click event on the effect control\r\n   * @param {Actor|Item} owner      The owning entity which manages this effect\r\n   */\r\n  static onManageActiveEffect(event: ClickEvent, owner: Actor|Item) {\r\n    event.preventDefault();\r\n    const a = event.currentTarget as HTMLElement;\r\n    if (a.dataset.action === \"create\") {\r\n      return owner.createEmbeddedDocuments(\"ActiveEffect\", [{\r\n        name: owner.name,\r\n        icon: owner.img,\r\n        origin: owner.uuid\r\n      }]);\r\n    }\r\n    const selector = a.closest(\"tr\");\r\n    if (selector === null) { return null }\r\n    const effect = selector.dataset.effectId ? owner.effects.get(selector.dataset.effectId) as BladesActiveEffect : null;\r\n    if (!effect) { return null }\r\n    switch ( a.dataset.action ) {\r\n      case \"edit\":\r\n        return effect.sheet?.render(true);\r\n      case \"delete\":\r\n        eLog.checkLog(\"activeEffects\", \"delete effect\");\r\n        return effect.delete();\r\n      case \"toggle\":\r\n        return effect.update({disabled: !effect.disabled});\r\n      // no default\r\n    }\r\n    return null;\r\n  }\r\n\r\n  override async _preCreate(data: any, options: any, user: User) {\r\n    eLog.checkLog3(\"effect\", \"ActiveEffect._preCreate()\", {data, options, user});\r\n    super._preCreate(data, options, user);\r\n  }\r\n  override async _onDelete(options: any, userID: string) {\r\n    eLog.checkLog3(\"effect\", \"ActiveEffect._onDelete()\", {options, userID});\r\n    super._onDelete(options, userID);\r\n  }\r\n\r\n  override get isSuppressed() {\r\n    // Get source item from 'origin' field -- of form 'Actor.<id>.Item.<id>'\r\n    if (!/Actor.*Item/.test(this.origin)) { return super.isSuppressed }\r\n    const [actorID, itemID] = this.origin.replace(/Actor\\.|Item\\./g, \"\").split(\".\");\r\n    const actor = game.actors.get(actorID) as BladesActor;\r\n    const item = actor.items.get(itemID) as BladesItem;\r\n    return super.isSuppressed || item?.hasTag(Tag.System.Archived);\r\n  }\r\n}\r\n\r\ndeclare interface BladesActiveEffect {\r\n  icon: string,\r\n  origin: string\r\n  disabled: boolean\r\n  changes: EffectChangeData[]\r\n  updateSource(updateData: List<any>): Promise<void>\r\n}\r\n\r\nexport default BladesActiveEffect;"]}